# GitHub Copilot Instructions for lhs-format

## Project Overview

This is `lhs-format`, a literate Haskell formatter designed for the acme text editor. The project consists of a shell script that processes bird-style literate Haskell (.lhs) files, preserving prose while formatting Haskell code sections.

## Architecture

### Core Components

1. **Main Script** (`lhs-format`): A POSIX-compliant bash script that:
   - Extracts code lines (starting with `>`) from .lhs files
   - Applies Haskell formatting using available tools (fourmolu, ormolu, stylish-haskell)
   - Reconstructs the .lhs file preserving all prose text exactly
   - Handles edge cases like formatters that change line counts

2. **Integration**: Works with acmego (acme formatting daemon) for automatic formatting

### Key Design Principles

- **Prose Preservation**: All non-code text must be preserved exactly as written
- **Graceful Degradation**: Falls back to basic formatting when advanced formatters unavailable
- **Line Count Resilience**: Handles formatters that add/remove lines (imports, blank lines)
- **POSIX Compatibility**: Uses portable shell constructs for maximum compatibility

## Code Style & Conventions

### Shell Script Guidelines

- Use POSIX-compliant bash features
- Prefer `[[ ]]` for conditionals when bash-specific features needed
- Use proper error handling with `set -euo pipefail`
- Include cleanup traps for temporary files
- Use meaningful variable names with consistent naming

### Error Handling

- Always check command exit codes
- Provide helpful error messages to stderr
- Clean up temporary files on both success and failure
- Use non-zero exit codes for errors

### Temporary File Management

- Use `mktemp` for temporary files with proper patterns
- Store temp files in `/tmp/lhs-format.XXXXXX.*` pattern
- Clean up with trap handlers
- Never leave temporary files behind

## Key Functions

### `extract_code()`
Extracts Haskell code lines from literate Haskell files.
- Input: .lhs file path
- Process: `grep '^>' | sed 's/^> //'`
- Output: Pure Haskell code to temporary file

### `reconstruct_lhs()`
Rebuilds .lhs file with formatted code and preserved prose.
- Strategy: Replace entire code sections as blocks (not line-by-line)
- Handles formatters that change line counts
- Preserves all prose sections exactly

### `main()`
Orchestrates the formatting process with proper error handling and cleanup.

## Formatter Integration

### Supported Formatters (in priority order)
1. **ormolu** - Modern formatter with minimal diffs
2. **fourmolu** - Configurable ormolu fork 
3. **stylish-haskell** - Import/pragma formatter
4. **basic** - Fallback whitespace cleanup

### Adding New Formatters
When adding support for new Haskell formatters:

1. Add detection in formatter checking section
2. Add case in formatting switch statement
3. Handle formatter-specific invocation (stdin vs file)
4. Test with various .lhs files to ensure prose preservation
5. Update documentation

## Testing Strategy

### Test Files
- `examples/simple.lhs`: Basic functionality
- `examples/complex.lhs`: Advanced Haskell features
- `examples/edge-cases.lhs`: Comments, empty lines, indented prose

### Test Scenarios
- File input/output formatting
- Stdin/stdout pipeline usage
- Formatter availability/unavailability
- Line count changes from formatters
- Edge cases (empty files, no code sections, malformed input)

## Common Issues & Solutions

### Line Count Mismatches
When formatters add/remove lines, use block replacement strategy:
- Extract all code as one block
- Format the block
- Replace first code section with entire formatted result
- Skip remaining original code sections

### Prose Preservation
Critical requirement: ALL non-code text must remain exactly as written.
- No modifications to lines not starting with `>`
- Preserve whitespace, indentation, empty lines in prose
- Handle mixed content correctly

### macOS Compatibility
- Use `sed -i ''` syntax for macOS
- Fallback to `sed -i` for Linux
- Handle missing `mapfile` command (use `sed -n` instead)

## Acme Integration

The formatter integrates with acmego through:
- Stdin/stdout processing for acme workflow  
- Special case handling in acmego's reformat function
- File extension mapping (`.lhs` â†’ `lhs-format`)

## Contributing Guidelines

When modifying the formatter:

1. **Test thoroughly** with all example files
2. **Preserve backwards compatibility** 
3. **Maintain POSIX compliance** where possible
4. **Update documentation** for new features
5. **Test with multiple formatters** (fourmolu, ormolu if available)
6. **Verify acme integration** still works

## Development Environment

- Requires: bash, sed, grep (POSIX utilities)
- Optional: fourmolu/ormolu/stylish-haskell for advanced formatting
- Test environment: macOS and Linux compatibility
- Integration test: acme + acmego

## File Patterns

- Input: `*.lhs` files (literate Haskell)
- Temporary: `/tmp/lhs-format.XXXXXX.*`
- Code extraction: Bird-style (`> code`) only
- Output: Formatted .lhs with preserved prose

This project prioritizes reliability, prose preservation, and seamless editor integration over complex features.